<img src="logo/falconLogo.png" alt="falcon logo" style="border:none" />

This repository contains data and scripts for a collation processing workflow, and it's evaluation.

<!-- TODO: name to be altered-->
- `collazione`: Python code;
- `data`: contains pre-processed data (sources in txt or xml), input data, and manually annotated validation data for comparison.


## Installing

```bash
# Recommended steps (use virtualenv)
virtualenv env -p python3
source env/bin/activate
# end recommended steps

# begin install
pip install -r requirements.txt
```

Please note that installation requirements for medieval Spanish only are listed <a href="freeling">below</a>.



## Sample usage

```bash
# Lemmatise raw (txt) files for ulterior collation
python3 main.py <path> [--lemmatise] [--lang] [--engine]

# Collate annotated files in XML
# containing (possibly human-corrected) linguistic information
python3 main.py <path> [--collate]

# Or, alternatively, do it all in one row
python3 main.py <path> [--lemmatise] [--lang] [--engine] [--collate]
```

To evaluate the results:

```bash
python eval.py <path_to_gt> <path_to_results> [--print_diff]
# e.g., evaluate Alexis results
python eval.py data/eval/alexis/ALEXIS_gt.xml data/eval/alexis/ALEXIS_out.xml
```

For simple collation from the txt sources, without preprocessing:

```bash
python main.py <path> [--simple]
# e.g., evaluate Alexis results
python main.py data/eval/alexis/sources --simple
```


More info about usage and examples are available <a href="#info">below</a>.

## Format for XML annotated files

If you want to use directly XML annotated files,
they must be in TEI, and contain `<w>` tags,
with `@lemma`, and possibly `@pos` and `@msd` tags,

```xml
<w 
  lemma="mëisme" 
  pos="ADJind" 
  msd="NOMB.=s|GENRE=m|CAS=r"
>meisme</w>
```
Or, possibly, use an `@type`,

```xml
<w 
  lemma="mëisme"
  type="ADJind|NOMB.=s|GENRE=m|CAS=r"
>meisme</w>
```


<span id="info"></span>
## Examples and usage additional info

### Lemmatisation

```bash
# Lemmatise raw (txt) files for ulterior collation
python3 main.py <path> [--lemmatise] [--lang] [--engine]
```

This step takes txt files and produces annoted XML files.

The options currently available for the language and the engine are:

old French annotated using [Pie](https://github.com/emanjavacas/pie), as in this example
```bash
python3 main.py data/input/chevLyon/sources --lemmatise --lang fro --engine pie
```

medieval Spanish annotated using [Freeling](http://nlp.lsi.upc.edu/freeling/), as in this example
```bash
python3 main.py data/input/lucanor/sources --lemmatise --lang spo --engine freeling
```

### Collation

```bash
# Collate annotated files in XML
# containing (possibly human-corrected) linguistic information
python3 main.py <path> [--collate]
```

This step takes XML files and collate them. The results are saved in XML and in txt in the text directory. Here it is an example

```bash
python3 main.py data/input/chevLyon/sources --collate
```

Before collating, you might want to correct the XML generated by the previous step. For avoiding over-writing, move the XML files to a new directory before editing them and edit the path accordingly before launching the command.

### All together

```bash
python3 main.py <path> [--lemmatise] [--lang] [--engine] [--collate]
```

For example
```bash
python3 main.py data/input/chevLyon/sources --lemmatise --lang fro --engine pie --collate
```

<br/><br/><br/>

![collazione](https://upload.wikimedia.org/wikipedia/commons/8/8a/Barista_Fair_Trade_Coffee%2C_Gotgatan_67%2C_cappucino_%284386813991%29.jpg "Due cappucini")


<span id="freeling"></span>

## Freeling installation for this pipeline

*For medieval Spanish only!*

The following instructions are based on a Linux distribution, but instructions for other systems are available following the links to the Freeling documentation.

- Install SWIG, as indicated here https://talp-upc.gitbook.io/freeling-4-1-user-manual/installation/calling-freeling-library-from-languages-other-than-c++/apis-linux#apis-requirements

- Install freeling from sources (needed for API), as indicated here https://talp-upc.gitbook.io/freeling-4-1-user-manual/installation/installation-source Attention: add argument for Python3 to `cmake ..`
```bash
cmake .. -DPYTHON3_API=ON`
```
- Test freeling (https://talp-upc.gitbook.io/freeling-4-1-user-manual/installation/using-freeling/test-linux):

```bash
/usr/local/bin/analyze -f en.cfg < Desktop/mytext.txt
/usr/local/bin/analyze -f en.cfg < Desktop/mytext.txt --output xml
```

- Fix and test medieval Spanish 'es-old' configuration file

Change in /usr/local/share/freeling/es/es-old/dicc.src --> lines 1 to 5 become
```xml
<IndexType>
DB_MAP
<\IndexType>
<Entries>
&cetera etcétera Fs etcétera NCMS000
```
Change in es-old.cfg --> line 77, path was mistaken --> ProbabilityFile=$FREELINGSHARE/es/es-old/probabilitats.dat

Change in es-old/probabilitats.dat --> line 13, path was mistaken --> ../tagset.dat

Change in es-old/constr_gram.dat -->	find and replace '\t\*' > '\tXX\*' ; and find and replace ' \*\);' > ' XX\*\);'

Change in es-old/tagger.dat --> line 2, path was mistaken --> ../tagset.dat

<b>Test</b>
```bash
/usr/local/bin/analyze -f es-old.cfg < Desktop/ms6376.txt
```

- Test the Python api, as indicated here

https://talp-upc.gitbook.io/freeling-4-1-user-manual/installation/calling-freeling-library-from-languages-other-than-c++/apis-linux#python

Text for test should be at list one sentence for the program to be able to detect language. Default lang is spanish.
	
```bash
set FREELINGDIR=/usr/local
cd /usr/local/share/freeling/APIs/python3
python sample.py < mytext.txt > mytextOUTPUT.txt
```

**Once Freeling is installed, install what is needed for this pipeline**

All you need is

```bash
# Recommended steps (use virtualenv)
virtualenv env -p python3
source env/bin/activate
# end recommended steps, begin install
pip install -r requirements_spo.txt
```